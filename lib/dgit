# A module for working with dgit(1) repositories
#
# Copyright (C) 2017 Sean Whitton
#
# Maintainer: Sean Whitton <spwhitton@spwhitton.name>

# DEFINITION
#
# A dgit repository is a git repository containing special remote refs
# of the form `remotes/dgit/dgit/*` and possibly also branches of the
# form `dgit/*`.  See dgit(7) for more details.
#
# USAGE
#
# To make mr use this file, add a line like this inside the [DEFAULT]
# section of your ~/.mrconfig:
#
#   include = cat /usr/share/mr/dgit
#
# With this module active,
#
# `mr update` will:
#
# (1) if the current branch is named `dgit/SUITE`, call `dgit pull SUITE`.
#
# (2) use `dgit fetch` to update all remotes/dgit/dgit/*` refs.
#
# `mr register` will add a post_checkout hook that calls `dgit fetch`.
#
# DESIGN
#
# A dgit repository may have been obtained with `dgit clone`, or `git
# clone` followed by `dgit fetch`.  It is not possible for us to
# determine which of these methods was used after the fact.
#
# For this reason, we do not define dgit_register and dgit_test so as
# to generate .mrconfig lines like
#
#   [foo]
#   checkout = dgit clone foo
#
# because that would fail to fetch branches not published to
# dgit-repos, such as branches published to alioth.debian.org.
#
# Instead, we extend git_update and git_register to obtain updates
# from dgit-repos.

git_update_append =
    # (1) above
    if [ "$(git rev-parse --abbrev-ref HEAD | cut -d/ -f1)" = "dgit" ]; then
        dgit pull
    fi
    # (2) above
    for ref in $(git show-ref | cut -d\  -f2 | grep ^refs/remotes/dgit/dgit); do
        suite=$(echo $ref | sed 's|refs/remotes/dgit/dgit/||')
        dgit fetch $suite
    done
